#!/bin/bash

PREFIX="$(realpath $(dirname "${0}")/..)"
POLICY_DIR="${POLICY_DIR:-${PREFIX}/lib/ifio}"
TMPDIR="$(mktemp -d)"
CONFIG="${TMPDIR}/config"
ENVVARS="${TMPDIR}/vars"

trap 'rm -rf "${TMPDIR}"' EXIT

cat ${POLICY_DIR}/* > "${CONFIG}"
grep '\[assess .*\]' "${CONFIG}" | \
sed 's/\[assess \(.*\)\]/\1/' | \
while read entry; do
  (
    set -e
    source <(wzk-sekt -n -t 'assess' "${CONFIG}" "${entry}")
  )
  if [ $? -eq 0 ]; then
    wzk-sekt -n -t 'assign' "${CONFIG}" "${entry}" | \
    while read env; do
comm -12 <(env | sed 's/=.*//' | sort) <( | sed 's/=.*//' | sort)
    done
  fi
done
